<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SafeErase Pro - Wipe Wizard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: #ffffff; min-height: 100vh; overflow-x: hidden;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 40px; }
    .header h1 { font-size: 2.5rem; font-weight: 700; background: linear-gradient(45deg, #00d4ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
    .header p { color: #a0a0a0; font-size: 1.1rem; }
    
    .wizard { display: flex; gap: 20px; }
    .main-content { flex: 2; }
    .sidebar { flex: 1; }
    
    .steps { display: flex; justify-content: center; margin-bottom: 30px; }
    .step { 
      display: flex; align-items: center; padding: 12px 24px; margin: 0 5px; 
      background: rgba(255,255,255,0.1); border-radius: 25px; cursor: pointer;
      transition: all 0.3s ease; border: 2px solid transparent;
    }
    .step.active { background: linear-gradient(45deg, #00d4ff, #00ff88); color: #000; font-weight: 600; }
    .step.completed { background: rgba(0, 255, 136, 0.2); border-color: #00ff88; }
    
    .panel { display: none; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    .panel.active { display: block; }
    
    .device-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .device-card { 
      background: rgba(255,255,255,0.08); border-radius: 10px; padding: 20px; cursor: pointer;
      transition: all 0.3s ease; border: 2px solid transparent;
    }
    .device-card:hover { background: rgba(255,255,255,0.12); transform: translateY(-2px); }
    .device-card.selected { border-color: #00d4ff; background: rgba(0, 212, 255, 0.1); }
    .device-name { font-weight: 600; font-size: 1.1rem; margin-bottom: 5px; }
    .device-meta { color: #a0a0a0; font-size: 0.9rem; }
    .device-size { color: #00ff88; font-weight: 600; margin-top: 8px; }
    
    .method-card { 
      background: rgba(0, 212, 255, 0.1); border: 2px solid #00d4ff; border-radius: 10px; 
      padding: 20px; margin: 20px 0; text-align: center;
    }
    .method-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 10px; }
    .method-desc { color: #a0a0a0; }
    
    .confirm-inputs { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
    .confirm-input { 
      padding: 12px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px; color: #fff; font-size: 1rem;
    }
    .confirm-input:focus { outline: none; border-color: #00d4ff; }
    .confirm-error { color: #ff4757; font-size: 0.9rem; margin-top: 5px; display: none; }
    
    .progress-container { text-align: center; margin: 40px 0; }
    .progress-circle { 
      width: 200px; height: 200px; margin: 0 auto 30px; position: relative;
      background: conic-gradient(#00d4ff 0deg, #00d4ff var(--progress, 0deg), rgba(255,255,255,0.1) var(--progress, 0deg));
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
    }
    .progress-inner { 
      width: 160px; height: 160px; background: #1a1a2e; border-radius: 50%; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .progress-percent { font-size: 2.5rem; font-weight: 700; color: #00d4ff; }
    .progress-label { font-size: 0.9rem; color: #a0a0a0; margin-top: 5px; }
    
    .progress-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
    .progress-item { text-align: center; }
    .progress-item h4 { color: #00ff88; font-size: 1.1rem; margin-bottom: 5px; }
    .progress-item p { color: #a0a0a0; font-size: 0.9rem; }
    
    .status-message { 
      background: rgba(0, 212, 255, 0.1); border: 1px solid #00d4ff; border-radius: 8px;
      padding: 15px; text-align: center; margin: 20px 0; font-weight: 600;
    }
    
    .complete-container { text-align: center; margin: 40px 0; }
    .complete-icon { 
      width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(45deg, #00ff88, #00d4ff);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 4rem; color: #000; font-weight: 700;
    }
    .complete-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 20px; color: #00ff88; }
    .complete-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
    .complete-item { text-align: center; }
    .complete-item h4 { color: #00d4ff; font-size: 1.1rem; margin-bottom: 5px; }
    .complete-item p { color: #a0a0a0; font-size: 0.9rem; }
    
    .files-container { margin: 30px 0; }
    .files-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .file-card { 
      background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; border-radius: 8px;
      padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease;
    }
    .file-card:hover { background: rgba(0, 255, 136, 0.2); transform: translateY(-2px); }
    .file-icon { font-size: 2rem; margin-bottom: 10px; }
    .file-name { font-weight: 600; margin-bottom: 5px; }
    .file-desc { color: #a0a0a0; font-size: 0.8rem; }
    
    .btn { 
      padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block;
    }
    .btn-primary { background: linear-gradient(45deg, #00d4ff, #00ff88); color: #000; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .btn-secondary:hover { background: rgba(255,255,255,0.2); }
    .btn-success { background: #00ff88; color: #000; }
    .btn-success:hover { background: #00e677; }
    
    .sidebar-card { 
      background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px; 
      backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
      position: sticky; top: 20px;
    }
    .sidebar-card h3 { margin-bottom: 20px; color: #00d4ff; }
    .summary-item { margin-bottom: 15px; }
    .summary-label { color: #a0a0a0; font-size: 0.9rem; margin-bottom: 5px; }
    .summary-value { font-weight: 600; font-size: 1.1rem; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>SafeErase Pro</h1>
      <p>Secure Data Wiping Wizard</p>
      <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px;">
        <span style="color: #00ff88; font-size: 0.9rem;">üîí Offline Mode</span>
        <span style="color: #a0a0a0; font-size: 0.8rem;">‚Ä¢ No internet required</span>
      </div>
    </div>
    
    <div class="steps">
      <div class="step active" id="step1" onclick="setStep(1)">1. Pick Device</div>
      <div class="step" id="step2" onclick="setStep(2)">2. Suggested Method</div>
      <div class="step" id="step3" onclick="setStep(3)">3. Confirm Path √ó2</div>
      <div class="step" id="step4" onclick="setStep(4)">4. Wipe & Certificate</div>
    </div>
    
    <div class="wizard">
      <div class="main-content">
        <!-- Step 1: Device Selection -->
        <div class="panel active" id="panel1">
          <h2>Select Device to Wipe</h2>
          <p style="color: #a0a0a0; margin-bottom: 30px;">Choose the storage device you want to securely erase. All data will be permanently destroyed.</p>
          
          <div class="device-grid" id="deviceGrid">
            <!-- Devices will be populated by JavaScript -->
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <div style="display:flex; gap:12px;">
              <button class="btn btn-secondary" type="button" onclick="refreshDevices()">Refresh Devices</button>
              <button class="btn btn-primary" id="next1" disabled>Continue to Method</button>
            </div>
          </div>
        </div>
        
        <!-- Step 2: Method Suggestion -->
        <div class="panel" id="panel2">
          <h2>Suggested Wipe Method</h2>
          <p style="color: #a0a0a0; margin-bottom: 30px;">Based on your device type, we recommend the following secure erase method:</p>
          
          <div class="method-card">
            <div class="method-title" id="methodTitle">NVMe Sanitize</div>
            <div class="method-desc" id="methodDesc">NIST SP 800-88 compliant sanitize command for NVMe SSDs</div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="setStep(1)">‚Üê Back to Devices</button>
            <button class="btn btn-primary" onclick="goToConfirm()" style="margin-left: 15px;">Continue to Confirmation</button>
          </div>
        </div>
        
        <!-- Step 3: Double Confirmation -->
        <div class="panel" id="panel3">
          <h2>Double Confirmation Required</h2>
          <p style="color: #a0a0a0; margin-bottom: 30px;">Type the device path exactly twice to confirm you want to proceed with the wipe:</p>
          
          <div class="confirm-inputs">
            <input type="text" class="confirm-input" id="confirm1" placeholder="Type device path here..." oninput="checkConfirmation()">
            <input type="text" class="confirm-input" id="confirm2" placeholder="Type device path again..." oninput="checkConfirmation()">
            <div class="confirm-error" id="confirmError">Paths don't match or are incorrect</div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="setStep(2)">‚Üê Back to Method</button>
            <button class="btn btn-primary" id="startWipe" onclick="startWipe()" disabled style="margin-left: 15px;">Start Secure Wipe</button>
          </div>
        </div>
        
        <!-- Step 4: Progress & Results -->
        <div class="panel" id="panel4">
          <h2>Wipe Progress & Certificate</h2>
          
          <!-- Progress View -->
          <div id="progressView">
            <div class="progress-container">
              <div class="progress-circle" id="progressCircle">
                <div class="progress-inner">
                  <div class="progress-percent" id="progressPercent">0%</div>
                  <div class="progress-label">Complete</div>
                </div>
              </div>
            </div>
            
            <div class="progress-details">
              <div class="progress-item">
                <h4>Throughput</h4>
                <p id="throughput">0 MB/s</p>
              </div>
              <div class="progress-item">
                <h4>Time Remaining</h4>
                <p id="timeRemaining">Calculating...</p>
              </div>
              <div class="progress-item">
                <h4>Pass</h4>
                <p id="passInfo">1 of 3</p>
              </div>
            </div>
            
            <div class="status-message" id="statusMessage">Initializing...</div>
          </div>
          
          <!-- Complete View -->
          <div id="completeView" class="hidden">
            <div class="complete-container">
              <div class="complete-icon">‚úì</div>
              <div class="complete-title">Erase Complete!</div>
              
              <div class="complete-details">
                <div class="complete-item">
                  <h4>Time Taken</h4>
                  <p id="timeTaken">0h 18m 47s</p>
                </div>
                <div class="complete-item">
                  <h4>Total Passes</h4>
                  <p id="totalPasses">3 of 3</p>
                </div>
                <div class="complete-item">
                  <h4>Verification</h4>
                  <p id="verificationStatus">OK</p>
                </div>
              </div>
              
              <div class="files-container">
                <h3 style="margin-bottom: 20px; color: #00d4ff;">Generated Files</h3>
                <div class="files-grid" id="filesGrid">
                  <!-- Files will be populated by JavaScript -->
                </div>
                
                <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 15px; margin-top: 20px;">
                  <h4 style="color: #00ff88; margin-bottom: 10px;">üîí Offline Mode Features</h4>
                  <ul style="color: #a0a0a0; font-size: 0.9rem; margin: 0; padding-left: 20px;">
                    <li>Works completely offline - no internet required</li>
                    <li>Certificates can be shared for third-party verification</li>
                    <li>All operations are local and secure</li>
                    <li>Portable mode available for any computer</li>
                  </ul>
                </div>
              </div>
              
              <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="verifySignature()">Verify Signature</button>
                <button class="btn btn-primary" onclick="startNewWipe()" style="margin-left: 15px;">Start New Wipe</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-card">
          <h3>Summary</h3>
          <div class="summary-item">
            <div class="summary-label">Selected Device</div>
            <div class="summary-value" id="selectedDevice">None</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Device Type</div>
            <div class="summary-value" id="deviceType">‚Äî</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Size</div>
            <div class="summary-value" id="deviceSize">‚Äî</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Method</div>
            <div class="summary-value" id="wipeMethod">‚Äî</div>
          </div>
          <div class="summary-item" id="validationWarnings" style="display: none;">
            <div class="summary-label">Validation Warnings</div>
            <div class="summary-value" id="validationWarningsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let devices = [];
    let selectedDevice = null;
    let statusInterval = null;
    
    function setStep(step) {
      // Update step indicators
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`step${i}`);
        const panelEl = document.getElementById(`panel${i}`);
        
        if (i === step) {
          stepEl.classList.add('active');
          panelEl.classList.add('active');
        } else {
          stepEl.classList.remove('active');
          panelEl.classList.remove('active');
        }
      }
    }
    
    function refreshDevices() {
      fetch('/api/devices')
        .then(response => response.json())
        .then(data => { 
          devices = data; 
          const grid = document.getElementById('deviceGrid');
          grid.innerHTML = '';
          data.forEach(device => {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.onclick = () => {
              document.querySelectorAll('.device-card').forEach(c => c.classList.remove('selected'));
              card.classList.add('selected');
              selectedDevice = device;
              document.getElementById('selectedDevice').textContent = `/dev/${device.name}`;
              document.getElementById('deviceType').textContent = device.model || 'Unknown';
              document.getElementById('deviceSize').textContent = device.size || 'Unknown';
              const btn = document.getElementById('next1');
              btn.disabled = false;
              btn.onclick = function(){
                for (let i = 1; i <= 4; i++) {
                  const stepEl = document.getElementById(`step${i}`);
                  const panelEl = document.getElementById(`panel${i}`);
                  if (i === 2) {
                    stepEl.classList.add('active');
                    panelEl.classList.add('active');
                  } else {
                    stepEl.classList.remove('active');
                    panelEl.classList.remove('active');
                  }
                }
              };
            };
            card.innerHTML = `
              <div class="device-name">${device.name}</div>
              <div class="device-meta">${device.model || 'Unknown Model'}</div>
              <div class="device-size">${device.size || 'Unknown Size'}</div>
            `;
            grid.appendChild(card);
          });
        })
        .catch(err => console.error('Device refresh failed:', err));
    }

    function loadDevices() {
      refreshDevices();
    }
    
    function renderDevices() {
      const grid = document.getElementById('deviceGrid');
      grid.innerHTML = '';
      
      devices.forEach(device => {
        const card = document.createElement('div');
        card.className = 'device-card';
        card.onclick = () => selectDevice(device, card);
        
        card.innerHTML = `
          <div class="device-name">${device.name}</div>
          <div class="device-meta">${device.model || 'Unknown Model'}</div>
          <div class="device-size">${device.size || 'Unknown Size'}</div>
        `;
        
        grid.appendChild(card);
      });
    }
    
    function selectDevice(device, cardElement) {
      // Remove previous selection
      document.querySelectorAll('.device-card').forEach(card => card.classList.remove('selected'));
      
      // Select new device
      cardElement.classList.add('selected');
      selectedDevice = device;
      
      // Update summary
      document.getElementById('selectedDevice').textContent = `/dev/${device.name}`;
      document.getElementById('deviceType').textContent = device.model || 'Unknown';
      document.getElementById('deviceSize').textContent = device.size || 'Unknown';
      
      // Clear validation warnings initially
      document.getElementById('validationWarnings').style.display = 'none';
      document.getElementById('validationWarningsList').innerHTML = '';
      
      // Enable continue button and wire click inline to avoid scope issues
      const btn = document.getElementById('next1');
      btn.disabled = false;
      btn.onclick = function(){
        // Switch to Suggested Method
        for (let i = 1; i <= 4; i++) {
          const stepEl = document.getElementById(`step${i}`);
          const panelEl = document.getElementById(`panel${i}`);
          if (i === 2) {
            stepEl.classList.add('active');
            panelEl.classList.add('active');
          } else {
            stepEl.classList.remove('active');
            panelEl.classList.remove('active');
          }
        }
      };
    }
    
    function goToMethod() {
      if (!selectedDevice) return;
      
      // Determine wipe method
      const isNVMe = selectedDevice.name.startsWith('nvme') || 
                     (selectedDevice.tran && selectedDevice.tran.toLowerCase().includes('nvme'));
      const isUSB = selectedDevice.tran && selectedDevice.tran.toLowerCase().includes('usb');
      
      let method, description;
      if (isNVMe) {
        method = 'NVMe Sanitize';
        description = 'NIST SP 800-88 compliant sanitize command for NVMe SSDs';
      } else if (isUSB) {
        method = 'USB Secure Erase';
        description = 'Secure erase using hdparm for USB storage devices';
      } else {
        method = 'SATA Secure Erase';
        description = 'ATA secure erase using hdparm for SATA drives';
      }
      
      document.getElementById('methodTitle').textContent = method;
      document.getElementById('methodDesc').textContent = description;
      document.getElementById('wipeMethod').textContent = method;
      
      setStep(2);
    }
    
    function goToConfirm() {
      setStep(3);
    }
    
    function checkConfirmation() {
      const path1 = document.getElementById('confirm1').value.trim();
      const path2 = document.getElementById('confirm2').value.trim();
      const expectedPath = selectedDevice ? (selectedDevice.path || `/dev/${selectedDevice.name}`) : '';
      const errorEl = document.getElementById('confirmError');
      const startBtn = document.getElementById('startWipe');
      
      const isValid = path1 === expectedPath && path2 === expectedPath && path1 !== '';
      
      if (path1 && path2) {
        errorEl.style.display = isValid ? 'none' : 'block';
      } else {
        errorEl.style.display = 'none';
      }
      
      startBtn.disabled = !isValid;
    }
    
    function startWipe() {
      if (!selectedDevice) return;
      
      setStep(4);
      startProgressPolling();
      
      // Start the wipe process
      fetch('/api/wipe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device: selectedDevice.path || `/dev/${selectedDevice.name}` })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.error('Wipe error:', data.error);
        }
      })
      .catch(error => console.error('Error starting wipe:', error));
    }
    
    function startProgressPolling() {
      statusInterval = setInterval(() => {
        fetch('/api/status')
          .then(response => response.json())
          .then(status => {
            updateProgress(status);
            
            if (status.completed) {
              clearInterval(statusInterval);
              showComplete(status);
            }
          })
          .catch(error => console.error('Error polling status:', error));
      }, 1000);
    }
    
    function updateProgress(status) {
      const progress = status.progress || 0;
      const progressCircle = document.getElementById('progressCircle');
      const progressPercent = document.getElementById('progressPercent');
      const throughput = document.getElementById('throughput');
      const timeRemaining = document.getElementById('timeRemaining');
      const passInfo = document.getElementById('passInfo');
      const statusMessage = document.getElementById('statusMessage');
      
      // Update progress circle
      progressCircle.style.setProperty('--progress', `${progress * 3.6}deg`);
      progressPercent.textContent = `${Math.round(progress)}%`;
      
      // Update details
      throughput.textContent = status.throughput || '0 MB/s';
      timeRemaining.textContent = status.time_remaining || 'Calculating...';
      passInfo.textContent = `${status.current_pass || 1} of ${status.total_passes || 3}`;
      statusMessage.textContent = status.status_message || 'Processing...';
      
      // Update validation warnings if present
      if (status.validation_warnings && status.validation_warnings.length > 0) {
        const warningsEl = document.getElementById('validationWarnings');
        const warningsListEl = document.getElementById('validationWarningsList');
        warningsEl.style.display = 'block';
        warningsListEl.innerHTML = status.validation_warnings.map(warning => 
          `<div style="color: #ff6b6b; font-size: 12px; margin: 2px 0;">${warning}</div>`
        ).join('');
      }
    }
    
    function showComplete(status) {
      document.getElementById('progressView').classList.add('hidden');
      document.getElementById('completeView').classList.remove('hidden');
      
      // Update completion details
      document.getElementById('timeTaken').textContent = '0h 18m 47s'; // Simulated
      document.getElementById('totalPasses').textContent = `${status.total_passes || 3} of ${status.total_passes || 3}`;
      document.getElementById('verificationStatus').textContent = status.verification === 'passed' ? 'OK' : 'Failed';
      
      // Show files
      const filesGrid = document.getElementById('filesGrid');
      filesGrid.innerHTML = '';
      
      const fileTypes = [
        { name: 'wipelog.json', icon: 'üìÑ', desc: 'Raw wipe log' },
        { name: 'wipelog_signed.json', icon: 'üîê', desc: 'Digitally signed log' },
        { name: 'nist_certificate.pdf', icon: 'üìã', desc: 'PDF certificate' }
      ];
      
      fileTypes.forEach(file => {
        const fileCard = document.createElement('div');
        fileCard.className = 'file-card';
        fileCard.onclick = () => downloadFile(file.name);
        
        fileCard.innerHTML = `
          <div class="file-icon">${file.icon}</div>
          <div class="file-name">${file.name}</div>
          <div class="file-desc">${file.desc}</div>
        `;
        
        filesGrid.appendChild(fileCard);
      });
    }
    
    function downloadFile(filename) {
      // Prefer the safe /download route
      const target = `/app/out/${filename}`;
      fetch('/download?path=' + encodeURIComponent(target))
        .then(resp => {
          if (resp.status === 200) {
            window.open('/download?path=' + encodeURIComponent(target), '_blank');
          } else {
            // Fallback to legacy route if needed
            const legacy = filename === 'nist_certificate.pdf' ? 'certificate.pdf' : filename;
            window.open(`/files/out/${legacy}`, '_blank');
          }
        })
        .catch(() => {
          const legacy = filename === 'nist_certificate.pdf' ? 'certificate.pdf' : filename;
          window.open(`/files/out/${legacy}`, '_blank');
        });
    }
    
    function verifySignature() {
      fetch('/api/verify')
        .then(response => response.json())
        .then(data => {
          const status = document.getElementById('verificationStatus');
          if (data.status === 'valid') {
            status.textContent = 'OK ‚úì';
            status.style.color = '#00ff88';
          } else {
            status.textContent = 'Failed ‚úó';
            status.style.color = '#ff4757';
          }
        })
        .catch(error => {
          console.error('Verification error:', error);
          document.getElementById('verificationStatus').textContent = 'Error';
        });
    }
    
    function startNewWipe() {
      // Reset all state
      selectedDevice = null;
      
      // Clear any running intervals
      if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
      }
      
      // Reset UI elements
      document.getElementById('selectedDevice').textContent = 'None';
      document.getElementById('deviceType').textContent = '‚Äî';
      document.getElementById('deviceSize').textContent = '‚Äî';
      document.getElementById('wipeMethod').textContent = '‚Äî';
      
      // Clear confirmation inputs
      document.getElementById('confirm1').value = '';
      document.getElementById('confirm2').value = '';
      document.getElementById('confirmError').style.display = 'none';
      document.getElementById('startWipe').disabled = true;
      
      // Reset progress view
      document.getElementById('progressView').classList.remove('hidden');
      document.getElementById('completeView').classList.add('hidden');
      
      // Reset progress circle
      document.getElementById('progressCircle').style.setProperty('--progress', '0deg');
      document.getElementById('progressPercent').textContent = '0%';
      document.getElementById('throughput').textContent = '0 MB/s';
      document.getElementById('timeRemaining').textContent = 'Calculating...';
      document.getElementById('passInfo').textContent = '1 of 3';
      document.getElementById('statusMessage').textContent = 'Initializing...';
      
      // Reset step indicators
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i === 1) {
          stepEl.classList.add('active');
        } else {
          stepEl.classList.remove('active');
        }
      }
      
      // Reset panels
      for (let i = 1; i <= 4; i++) {
        const panelEl = document.getElementById(`panel${i}`);
        if (i === 1) {
          panelEl.classList.add('active');
        } else {
          panelEl.classList.remove('active');
        }
      }
      
      // Reload devices
      loadDevices();
    }
    
    // Expose functions for buttons/console
    window.refreshDevices = refreshDevices;
    window.renderDevices = renderDevices;
    window.loadDevices = loadDevices;
    window.goToMethod = goToMethod;
    window.goToConfirm = goToConfirm;
    window.selectDevice = selectDevice;
    window.setStep = setStep;

    // Initialize
    loadDevices();
  </script>
</body>
</html>